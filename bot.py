import sqlite3
from aiogram import Bot, Dispatcher, executor, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
import datetime
from random import choice, randint
from aiogram.dispatcher import FSMContext
from string import ascii_letters, digits
from os import path
from sys import exit
from aiogram.types import message, message_id, user
from configparser import ConfigParser
import markups
import state_handler
from user import User
import user as usr
import stats

if not path.isfile("data.db"):
    print("–°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö...")

conn = sqlite3.connect('data.db')
c = conn.cursor()

c.execute('CREATE TABLE IF NOT EXISTS "cats" ("id" INTEGER, "name" TEXT NOT NULL, PRIMARY KEY("id"))')
c.execute('CREATE TABLE IF NOT EXISTS item_stock (id INTEGER PRIMARY KEY, item_id INTEGER, login TEXT, password TEXT)')
c.execute('CREATE TABLE IF NOT EXISTS "items" ("id" INTEGER, "name" TEXT NOT NULL, "price" FLOAT NOT NULL,"cat_id" INTEGER NOT NULL, "desc" TEXT, PRIMARY KEY("id"))')
c.execute('CREATE TABLE IF NOT EXISTS "orders" ("order_id" INTEGER NOT NULL, "user_id" INTEGER NOT NULL, "item_id" INTEGER NOT NULL, "details" TEXT NOT NULL, "date" TEXT NOT NULL)')
c.execute('CREATE TABLE IF NOT EXISTS "payments" ("payment_id" TEXT, "user_id" INTEGER, "summ" FLOAT, "done" INTEGER, "date" TEXT)')
c.execute('CREATE TABLE IF NOT EXISTS "support" ("id" INTEGER, "order_id" INTEGER NOT NULL, "user_id" INTEGER NOT NULL, "email" TEXT NOT NULL, "problem" TEXT NOT NULL, "item_name" TEXT NOT NULL, "item_details" INTEGER NOT NULL, "is_resolved" INTEGER NOT NULL, PRIMARY KEY("id"))')
c.execute('CREATE TABLE IF NOT EXISTS "users" ("user_id" INTEGER NOT NULL, "balance" FLOAT NOT NULL, "is_admin" INTEGER, "is_supplier" INTEGER, "is_support" INTEGER, "notification" INTEGER, "date_created" TEXT)')

if not path.isfile("config.ini"):
    with open("config.ini", 'w') as config:
        config.write("[main]\ntoken = –¢–æ–∫–µ–Ω\nmain_admin_id = ID –≥–ª–∞–≤–Ω–æ–≥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞\n\n[shop_settings]\nshop_name = –ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞\nrefund_policy = –ü–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞\nshop_contacts = –ö–æ–Ω—Ç–∞–∫—Ç—ã\n\n[payment_settings]\nqiwi_number = –ù–æ–º–µ—Ä –∫–∏–≤–∏ –∫–æ—à–µ–ª—å–∫–∞\nqiwi_token = –¢–æ–∫–µ–Ω –∫–∏–≤–∏ –∫–æ—à–µ–ª—å–∫–∞\nqiwi_isactive = 0\nmain_btc_adress = –ê–¥—Ä–µ—Å btc –∫–æ—à–µ–ª—å–∫–∞\nbtc_isactive = 0\n")
    conf = ConfigParser()
    conf.read("config.ini", encoding="utf-8")
    conf.set("main", "token", input("–î–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã –≤–≤–µ–¥–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞: "))
    
    while True:
        main_admin_id = input("–í–≤–µ–¥–∏—Ç–µ –≤–∞—à ID. (–ï–≥–æ –º–æ–∂–Ω–æ —É–∑–Ω–∞—Ç—å –≤ @userinfobot): ")
        if main_admin_id.isnumeric(): break

    conf.set("main", "main_admin_id", str(main_admin_id))
    print("–û—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –≤ üî¥–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å -> ‚öô–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞")
    
    with open("config.ini", 'w') as configfile:
        conf.write(configfile)

conf = ConfigParser()
conf.read('config.ini', encoding='utf8')


storage = MemoryStorage()
bot = Bot(token=conf['main']['token'])
dp = Dispatcher(bot, storage=storage)


def get_item_count(item_id):
    c.execute(f"SELECT * FROM item_stock WHERE item_id={item_id}")
    count = 0
    for _ in c:
        count += 1
    return count


@dp.message_handler(commands=['start'])
async def welcome(message: types.Message):
    conf = ConfigParser()
    conf.read('config.ini', encoding='utf8')

    user = User(message.chat.id)

    markupMain = markups.get_markup_main()
    adminPanel = types.KeyboardButton('üî¥–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å')

    if not usr.does_user_exist(message.chat.id):
        if str(message.chat.id) == conf['main']['main_admin_id']:
            c.execute(f"INSERT INTO users VALUEs({message.chat.id}, 0, 1, 0, 0, 0, \"{datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\")")
            conn.commit()
            markupMain.row(adminPanel)
        else:
            c.execute(f"INSERT INTO users VALUEs({message.chat.id}, 0, 0, 0, 0, 0, \"{datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')}\")")
            conn.commit()
    else:
        if user.is_admin():
            markupMain.row(adminPanel)
        if user.is_admin():
            btnSupport = types.KeyboardButton(text='‚òé–ú–µ–Ω—é —Ç–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫–∏')
            markupMain.row(btnSupport)

    sti = open('AnimatedSticker.tgs', 'rb')
    await bot.send_sticker(message.chat.id, sti)
    sti.close()
    await bot.send_message(message.chat.id,
                            f"–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ –º–∞–≥–∞–∑–∏–Ω –∞–∫–∫–∞—É–Ω—Ç–æ–≤ "
                            f"{conf['shop_settings']['shop_name']}, {message.from_user.first_name}!",
                           reply_markup=markupMain)


@dp.message_handler()
async def handle_text(message):
    user = User(message.chat.id)
    
    conf = ConfigParser()
    conf.read('config.ini', encoding='utf8')

    if message.text == 'üî¥–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å':
        if user.is_admin():
            await bot.send_message(message.chat.id, 'üî¥–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å', reply_markup=markups.get_admin_markup())

    elif message.text == '‚ÑπÔ∏èFAQ':
        markupFAQ = markups.get_faq_markup()
        await bot.send_message(message.chat.id, f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n‚ÑπÔ∏èFAQ –º–∞–≥–∞–∑–∏–Ω–∞ {conf["shop_settings"]["shop_name"]}'
                                                f'\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ', reply_markup=markupFAQ)
    elif message.text == 'üìÅ–ü—Ä–æ—Ñ–∏–ª—å':
        markupProfile = markups.get_markup_profile(user_id=message.chat.id)
        await bot.send_message(message.chat.id,
                               f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                               f"üìùid: {message.chat.id}\n"
                               f"üìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(message.chat.id))}\n"
                               f"üí∏–ë–∞–ª–∞–Ω—Å: {user.get_balance()}—Ä—É–±.\n"
                               f"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {user.get_register_date()}"
                               f"\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ",
                               reply_markup=markupProfile)

    elif message.text == 'üõí–ö–∞—Ç–∞–ª–æ–≥':
        catMarkup = types.InlineKeyboardMarkup()
        c.execute('SELECT * FROM cats')
        cats = list(c)
        for category in cats:
            btnCat = types.InlineKeyboardButton(text=category[1], callback_data=f"cat{category[0]}")
            catMarkup.add(btnCat)
        await bot.send_message(message.chat.id, '‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüõçÔ∏è–ö–∞—Ç–µ–≥–æ—Ä–∏–∏\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ',
                               reply_markup=catMarkup)

    else:
        await bot.send_message(message.chat.id, '–ù–µ –º–æ–≥—É –ø–æ–Ω—è—Ç—å –∫–æ–º–∞–Ω–¥—É :(')


@dp.callback_query_handler()
async def process_callback(callback_query: types.CallbackQuery):
    conf = ConfigParser()
    conf.read('config.ini', encoding='utf8')
    chatid = callback_query.message.chat.id
    callText = callback_query.data
    user = User(chatid)

    if callText[:3] == 'cat':
        catMarkup = types.InlineKeyboardMarkup()
        c.execute(f"SELECT * FROM cats WHERE id={callText[3:]}")
        try:
            cat = list(c)[0]
            
            c.execute(f"SELECT * FROM items WHERE cat_id={callText[3:]}")
            items = list(c)
            for item in items:
                amount = get_item_count(item[0])
                text = f'{item[1]} - {amount}—à—Ç. - {item[2]}—Ä—É–±.'
                btnCat = types.InlineKeyboardButton(text=text, callback_data=f"item{item[0]}")
                if item[5] == 1:
                    catMarkup.add(btnCat)
            catMarkup.add(markups.get_cat_back())
            await bot.edit_message_text(text=f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n{cat[1]}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ',
                                        chat_id=callback_query.message.chat.id,
                                        message_id=callback_query.message.message_id,
                                        reply_markup=catMarkup)
        except:
            markup = types.InlineKeyboardMarkup()
            markup.add(markups.get_cat_back())
            await bot.edit_message_text(
                text="–ö–∞—Ç–µ–≥–æ—Ä–∏–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!",
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markup
            )
    
    elif callText == "itemManagement":
        await bot.edit_message_text(
            text="üì¶–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–º",
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_item_management_markup()
        )
        
    elif callText == "addCat":
        await bot.edit_message_text(
            text="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\".",
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_items()
        )
        await state_handler.addCat.catname.set()
        
    elif callText == "editCats":
        c.execute("SELECT * FROM cats")
        cats = list(c)
        if cats:
            markup = types.InlineKeyboardMarkup()
            for cat in cats:
                markup.add(types.InlineKeyboardButton(text=f"[{cat[0]}] {cat[1]}", callback_data=f"editCat{cat[0]}"))
            markup.add(markups.goBackItems)
            
            await bot.edit_message_text(
                text="–í—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é, –∫–æ—Ç–æ—Ä—É—é —Ö–æ—Ç–∏—Ç–µ –∏–∑–º–µ–Ω–∏—Ç—å.",
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markup
            )
        else:
            await bot.edit_message_text(
                text="–í—ã –ø–æ–∫–∞ –Ω–µ –¥–æ–±–∞–≤–∏–ª–∏ –Ω–∏ –æ–¥–Ω–æ–π –∫–∞—Ç–µ–≥–æ—Ä–∏–∏.",
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.markups.get_items_back()
            )
    
    elif callText[:7] == "editCat":
        c.execute(F"SELECT * FROM cats WHERE id={callText[7:]}")
        cat = list(c)[0]
        
        await bot.edit_message_text(
            text=cat[1],
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cat_edit_markup(cat[0])
        )
        
    elif callText[:9] == "deleteCat":
        catid = callText[9:]
        c.execute(f"SELECT * FROM cats WHERE id={catid}")
        cat = list(c)[0]
        c.execute(f"DELETE FROM cats WHERE id={catid}")
        conn.commit()
        await bot.edit_message_text(
            text=f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è \"{cat[1]}\" —Å ID {cat[0]} –±—ã–ª–∞ —É–¥–∞–ª–µ–Ω–∞!",
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_back_cats_edit()
        )
    
    elif callText[:11] == "editNameCat":
        await bot.edit_message_text(
            text="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\".",
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_cats(callText[11:])
        )
        await state_handler.changeCatName.catname.set()
        state = Dispatcher.get_current().current_state()
        await state.update_data(catid=callText[11:])
        
    elif callText[:7] == "addItem":
        await bot.edit_message_text(
            text="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\"",
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_additem()
        )
        await state_handler.addItem.itemname.set()
    
    elif callText[:8] == "editItem":
        pass
    
    elif callText[:8] == "addStock":
        pass
        
    elif callText[:4] == 'item':
        c.execute(f"SELECT * FROM items WHERE id={callText[4:]}")
        for item in c:
            pass
        cat_id = item[3]
        await bot.edit_message_text(
                                    text=f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n{item[1]} - {item[2]}—Ä—É–±.\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n{item[4]}',
                                    chat_id=callback_query.message.chat.id,
                                    message_id=callback_query.message.message_id,
                                    reply_markup=markups.get_item_markup(item[0], cat_id)
                                    )
    elif callText[:7] == 'confirm':
        c.execute(f"SELECT * FROM items WHERE id={callText[7:]}")
        for item in c:
            pass
        await bot.edit_message_text(
            text=f'–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∫—É–ø–∏—Ç—å {item[1]} –∑–∞ {item[2]}?',
            chat_id=callback_query.message.chat.id,
            message_id=callback_query.message.message_id,
            reply_markup=markups.get_confirm_buy_markup(callText[7:])
        )
     
    elif callText[:17] == "changeUserBalance":
        await bot.edit_message_text(
            text=f"–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {callText[17:]} –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\".",
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_user(callText[17:])
        )
        await state_handler.changeUserBalance.bal.set()
        state = Dispatcher.get_current().current_state()
        await state.update_data(userid=callText[17:])

    elif callText[:15] == "removeUserAdmin":
        userid = callText[15:]
        if str(userid) != str(chatid):
            profuser = usr.User(userid)
            profuser.set_admin(0)
            text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
            await bot.edit_message_text(
                text=text,
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.get_seeUserProfile_markup(userid)
            )
        
    elif callText[:13] == "makeUserAdmin":
        userid = callText[13:]
        profuser = usr.User(userid)
        profuser.set_admin(1)
        text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_seeUserProfile_markup(userid)
        )
    
    elif callText[:18] == "removeUserSupplier":
        userid = callText[18:]
        profuser = usr.User(userid)
        profuser.set_supplier(0)
        text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_seeUserProfile_markup(userid)
        )
    
    elif callText[:16] == "makeUserSupplier":
        userid = callText[16:]
        profuser = usr.User(userid)
        profuser.set_supplier(1)
        text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_seeUserProfile_markup(userid)
        )
    
    elif callText[:17] == "removeUserSupport":
        userid = callText[17:]
        profuser = usr.User(userid)
        profuser.set_support(0)
        text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_seeUserProfile_markup(userid)
        )
    
    elif callText[:15] == "makeUserSupport":
        userid = callText[15:]
        profuser = usr.User(userid)
        profuser.set_support(1)
        text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_seeUserProfile_markup(userid)
        )
        
    elif callText[:13] == "seeUserOrders":
        userid = callText[13:]
        markup = types.InlineKeyboardMarkup()
        if not usr.get_user_orders(userid):
            text = f"–£ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {userid} –Ω–µ—Ç –∑–∞–∫–∞–∑–æ–≤."
        else:
            text = f"–ó–∞–∫–∞–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {userid}."
            for order in usr.get_user_orders(userid):
                try:
                    c.execute(f"SELECT * FROM items WHERE id={order[2]}")
                    itemname = list(c)[0][1]
                except:
                    itemname = "–¢–æ–≤–∞—Ä –±—ã–ª —É–¥–∞–ª—ë–Ω –∏–ª–∏ –ø—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞."
                markup.add(types.InlineKeyboardButton(text=f"[{itemname}] - {order[0]}", callback_data=f"seeOrderUser{order[0]}"))
        markup.add(markups.get_back_user_btn(userid))
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markup
        )
        
    elif callText[:12] == "seeOrderUser":
        orderid = callText[12:]
        c.execute(f"SELECT * FROM orders WHERE order_id={orderid}")
        order = list(c)[0]
        c.execute(f"SELECT * FROM items WHERE id={order[2]}")
        item = list(c)[0]
        text = f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n–ó–∞–∫–∞–∑ –Ω–æ–º–µ—Ä {orderid}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n–¢–æ–≤–∞—Ä: {item[1]}\n–õ–æ–≥–∏–Ω: {order[3].split(':')[0]}\n–ü–∞—Ä–æ–ª—å: {order[3].split(':')[1]}\n–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞: {order[4]}"
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_back_user_orders_markup(order[1])
        )
    
    elif callText[:8] == "userBack":
        userid = callText[8:]
        profuser = usr.User(userid)
        profuser.set_support(1)
        text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_seeUserProfile_markup(userid)
        )
        
    elif callText[:3] == 'buy':
        itemid = callText[3:]
        c.execute(f"SELECT * FROM items WHERE id={itemid}")
        for item in c:
            pass

        if get_item_count(itemid) > 0:
            if item[2] <= user.get_balance():

                c.execute(f"SELECT * FROM item_stock WHERE item_id={itemid}")
                unused_accounts = list(c)
                account = choice(unused_accounts)
                login = account[2]
                password = account[3]

                usr.set_user_balance(user_id=chatid, price=item[2], remove_value=True)

                if get_item_count(itemid) < 5:
                    for notif in usr.get_notif_list():
                        await bot.send_message(chat_id=notif[0],
                                               text=f'–¢–æ–≤–∞—Ä–∞ {item[1]} –≤—Å–µ–≥–æ {get_item_count(item[0]) - 1}—à—Ç. –≤ –Ω–∞–ª–∏—á–∏–∏!')
                c.execute(f"DELETE FROM item_stock WHERE login='{login}' AND password='{password}'")

                unique_fl = True
                while unique_fl:
                    order_id = randint(1000000000, 9999999999)
                    c.execute(f"SELECT * FROM orders WHERE order_id='{order_id}'")
                    if len(list(c)) == 0:
                        unique_fl = False

                logpass = f"{login}:{password}"
                c.execute(f"INSERT INTO orders VALUES({order_id}, {chatid}, {itemid}, '{logpass}', '{str(datetime.datetime.now())[:-7]}')")

                conn.commit()
                text = f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n' \
                       f'–ó–∞–∫–∞–∑ –Ω–æ–º–µ—Ä {order_id}\n' \
                       f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n' \
                       f'–õ–æ–≥–∏–Ω: {login}\n' \
                       f'–ü–∞—Ä–æ–ª—å: {password}\n'
                await bot.delete_message(chat_id=chatid, message_id=callback_query.message.message_id)
                await bot.send_message(
                    chat_id=chatid,
                    text=text
                )
            else:
                await bot.delete_message(chat_id=chatid, message_id=callback_query.message.message_id)
                await bot.send_message(
                    chat_id=chatid,
                    text=f'–£ –≤–∞—Å –Ω–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ :(\n–ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å, —á—Ç–æ–±—ã –ø–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å!'
                )
        else:
            await bot.delete_message(chat_id=chatid, message_id=callback_query.message.message_id)
            await bot.send_message(
                chat_id=chatid,
                text=f'–¢–æ–≤–∞—Ä–∞ {item[1]} –Ω–µ—Ç –≤ –Ω–∞–ª–∏—á–∏–∏'
            )
    elif callText == 'contacts':
        contactsMarkup = types.InlineKeyboardMarkup()
        contactsMarkup.add(markups.get_faq_back())
        text = conf['shop_settings']['shop_contacts'] + '\n\n–ë–æ—Ç —Å–¥–µ–ª–∞–Ω @w1png'
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=contactsMarkup,
        )
        
    elif callText == "notifyAll":
        msg = "–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ, –∫–æ—Ç–æ—Ä–æ–µ –≤—ã —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Å–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º, –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\"."
        await bot.edit_message_text(
            text=msg,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_clients()
        )
        await state_handler.notifyAll.message.set()
                
    elif callText == 'refund':
        refundMarkup = types.InlineKeyboardMarkup()
        refundMarkup.add(markups.get_faq_back())
        text = conf['shop_settings']['refund_policy']
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=refundMarkup,
        )
    elif callText == 'orders':
        orders = usr.get_user_orders(chatid)
        ordersMarkup = types.InlineKeyboardMarkup()
        for order in orders:
            c.execute(f"SELECT * FROM items WHERE id={order[2]}")
            for item in c:
                pass
            btn = types.InlineKeyboardButton(text=f'[{item[1]}] - {order[0]}', callback_data=f'order{order[0]}')
            ordersMarkup.add(btn)
        text = '‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n–í–∞—à–∏ –∑–∞–∫–∞–∑—ã\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
        ordersMarkup.add(markups.get_profile_back())
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=ordersMarkup
        )
        
    elif callText == "close":
        try:
            await bot.delete_message(
                message_id=callback_query.message.message_id,
                chat_id=chatid
            )
        except:
            await bot.send_message(
                text="–°–æ–æ–±—â–µ–Ω–∏–µ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å —É–¥–∞–ª–µ–Ω–æ!",
                chat_id=chatid
            )

    elif callText == 'backAdmin':
        if user.is_admin():
            await bot.edit_message_text(
                text='üî¥–ê–¥–º–∏–Ω –ø–∞–Ω–µ–ª—å',
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.get_admin_markup()
            )

    elif callText == 'mainSettings':
        await bot.edit_message_text(
            text='üõ†–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_main_settings_markup()
        )

    elif callText == 'qiwiSettings':
        await bot.edit_message_text(
            text='ü•ù–ù–∞—Å—Ç—Ä–æ–π–∫–∏ QIWI –∫–æ—à–µ–ª—å–∫–∞',
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_qiwi_settings()
        )

    elif callText == "seeUserProfile":
        await bot.edit_message_text(
            text="–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\"",
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_clients()
        )
        await state_handler.seeUserProfile.userid.set()

    elif callText == 'qiwiOn':
        conf.set('payment_settings', 'qiwi_isactive', '1')
        with open('config.ini', 'w') as config:
            conf.write(config)
        await bot.edit_message_text(
            text='ü•ù–ù–∞—Å—Ç—Ä–æ–π–∫–∏ QIWI –∫–æ—à–µ–ª—å–∫–∞',
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_qiwi_settings()
        )

    elif callText == 'qiwiOff':
        conf.set('payment_settings', 'qiwi_isactive', '0')
        with open('config.ini', 'w') as config:
            conf.write(config)

        await bot.edit_message_text(
            text='ü•ù–ù–∞—Å—Ç—Ä–æ–π–∫–∏ QIWI –∫–æ—à–µ–ª—å–∫–∞',
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_qiwi_settings()
        )

    elif callText == 'btcSettings':
        await bot.edit_message_text(
            text='üíµ–ù–∞—Å—Ç—Ä–æ–π–∫–∏ BTC –∫–æ—à–µ–ª—å–∫–∞',
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_btc_settings_markup(),
        )

    elif callText == 'btcOn':
        conf.set('payment_settings', 'btc_isactive', '1')
        with open('config.ini', 'w') as config:
            conf.write(config)
        await bot.edit_message_text(
            text='üíµ–ù–∞—Å—Ç—Ä–æ–π–∫–∏ BTC –∫–æ—à–µ–ª—å–∫–∞',
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_btc_settings_markup(),
        )

    elif callText == 'btcOff':
        conf.set('payment_settings', 'btc_isactive', '0')
        with open('config.ini', 'w') as config:
            conf.write(config)
        await bot.edit_message_text(
            text='üíµ–ù–∞—Å—Ç—Ä–æ–π–∫–∏ BTC –∫–æ—à–µ–ª—å–∫–∞',
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_btc_settings_markup(),
        )

    elif callText == 'balance':
        await bot.edit_message_text(
            text='üí∞–ü–æ–ø–æ–ª–Ω–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞',
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_balance_markup()
        )

    elif callText == "shopStats":
        await bot.edit_message_text(
            text=f"üìà–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞ (BETA)",
            chat_id=chatid,
            message_id=callback_query.message.message_id,
            reply_markup=markups.get_stats_markup()
        )

    elif callText[:10] == "orderStats":
        callText = callback_query.data
        chatid = callback_query.message.chat.id
        charts = stats.OrderCharts()

        if callText == "orderStats":
            await bot.edit_message_text(
                text=f"üì¶–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤",
                chat_id=chatid,
                message_id=callback_query.message.message_id,
                reply_markup=markups.get_order_stats_markup()
            )

        elif callText == "orderStatsAllTime":
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
                await bot.send_photo(
                    caption="–ó–∞–∫–∞–∑—ã –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è",
                    chat_id=chatid,
                    photo=charts.all_time(),
                    reply_markup=markups.get_order_stats_back()
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )

        elif callText == "orderStatsMonthly":
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
                await bot.send_photo(
                    caption="–ó–∞–∫–∞–∑—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π",
                    chat_id=chatid,
                    photo=charts.monthly(),
                    reply_markup=markups.get_order_stats_back()
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )
        
        elif callText == "orderStatsWeekly":
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
                await bot.send_photo(
                    caption="–ó–∞–∫–∞–∑—ã –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π",
                    chat_id=chatid,
                    photo=charts.weekly(),
                    reply_markup=markups.get_order_stats_back()
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )
        
        elif callText == "orderStatsDaily":
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
                await bot.send_photo(
                    caption="–ó–∞–∫–∞–∑—ã –∑–∞ —Å–µ–≥–æ–¥–Ω—è",
                    chat_id=chatid,
                    photo=charts.daily(),
                    reply_markup=markups.get_order_stats_back()
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )

        elif callText == "orderStatsBack":
            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_message(
                text=f"üì¶–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∑–∞–∫–∞–∑–æ–≤",
                chat_id=chatid,
                reply_markup=markups.get_order_stats_markup()
            )
    
    elif callText[:9] == "userStats":
        callText = callback_query.data
        chatid = callback_query.message.chat.id
        charts = stats.RegistrationCharts()
        

        if callText == 'userStats':
            await bot.edit_message_text(
                text='üë•–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π',
                chat_id=chatid,
                message_id=callback_query.message.message_id,
                reply_markup=markups.get_user_stats_markup()
            )

        elif callText == 'userStatsAllTime':
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
                await bot.send_photo(
                    chat_id=chatid,
                    caption='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞ –≤—Å—ë –≤—Ä–µ–º—è',
                    photo=charts.all_time(),
                    reply_markup=markups.get_user_stats_back(),
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )

        elif callText == 'userStatsMonth':
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
                await bot.send_photo(
                    chat_id=chatid,
                    caption='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π',
                    photo=charts.monthly(),
                    reply_markup=markups.get_user_stats_back(),
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )

        elif callText == 'userStatsWeek':
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
                await bot.send_photo(
                    chat_id=chatid,
                    caption='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π',
                    photo=charts.weekly(),
                    reply_markup=markups.get_user_stats_back(),
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )

        elif callText == 'userStatsDay':
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
                await bot.send_photo(
                    chat_id=chatid,
                    caption='–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è',
                    photo=charts.daily(),
                    reply_markup=markups.get_user_stats_back(),
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )

        elif callText == 'userStatsBack':
            try:
                await bot.delete_message(
                    chat_id=chatid,
                    message_id=callback_query.message.message_id
                )
            
                await bot.send_message(
                    text='üë•–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–π',
                    chat_id=chatid,
                    reply_markup=markups.get_user_stats_markup()
                )
            except:
                await bot.send_message(
                    chat_id=chatid,
                    text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞!"
                )

    elif callText == "statsSettings":
        await bot.delete_message(
            chat_id=chatid,
            message_id=callback_query.message.message_id
        )
        await bot.send_photo(
            caption=f"üìà–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
            chat_id=chatid,
            photo=stats.get_random_graph(),
            reply_markup=markups.get_stats_settings_markup()
        )

    elif callText == "statsSettingsBack":
        await bot.delete_message(
            chat_id=chatid,
            message_id=callback_query.message.message_id
        )
        await bot.send_photo(
            caption=f"üìà–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏",
            chat_id=chatid,
            photo=stats.get_random_graph(),
            reply_markup=markups.get_stats_settings_markup()
        )

    elif callText[:10] == "statsColor":
        if callText == "statsColor":
            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"üåà–¶–≤–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_color_markup()
            )
        
        else:
            match callText[10:]:
                case "Black":
                    color = "000000"
                case "White":
                    color = "ffffff"
                case "Red":
                    color = "cc0000"
                case "Yellow":
                    color = "ffff00"
                case "Purple":
                    color = "a957e3"
                case "Blue":
                    color = "3299ff"
                case "Orange":
                    color = "ffa500"
                case "Green":
                    color = "4ca64c"
                case "Brown":
                    color = "4c3100"
            conf.set("stats_settings", "barcolor", color)
            with open('config.ini', 'w') as config:
                conf.write(config)

            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"üåà–¶–≤–µ—Ç –≥—Ä–∞—Ñ–∏–∫–∞",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_color_markup()
            )

    elif callText[:16] == "statsBorderWidth":
        if callText == "statsBorderWidth":
            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"üî≤–®–∏—Ä–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_border_width_markup()
            )
        else:
            match callText[16:]:
                case "Add":
                    conf.set("stats_settings", "linewidth", str(int(conf["stats_settings"]["linewidth"]) + 1))
                case "Reduce":
                    conf.set("stats_settings", "linewidth", str(int(conf["stats_settings"]["linewidth"]) - 1))
            with open('config.ini', 'w') as config:
                conf.write(config)

            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"üî≤–®–∏—Ä–∏–Ω–∞ –æ–±–≤–æ–¥–∫–∏",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_border_width_markup()
            )

    elif callText[:18] == "statsTitleFontSize":
        if callText == "statsTitleFontSize":
            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"‚ÑπÔ∏è–†–∞–∑–º–µ—Ä –Ω–∞–∑–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_font_markup("titlefontsize", "statsTitleFontSize")
            )
        else:
            match callText[18:]:
                case "Add":
                    conf.set("stats_settings", "titlefontsize", str(int(conf["stats_settings"]["titlefontsize"]) + 2))
                case "Reduce":
                    conf.set("stats_settings", "titlefontsize", str(int(conf["stats_settings"]["titlefontsize"]) - 2))
            with open('config.ini', 'w') as config:
                conf.write(config)

            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"‚ÑπÔ∏è–†–∞–∑–º–µ—Ä –Ω–∞–∑–≤–∞–Ω–∏—è –≥—Ä–∞—Ñ–∏–∫–∞",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_font_markup("titlefontsize", "statsTitleFontSize")
            )

    elif callText[:17] == "statsAxisFontSize":
        if callText == "statsAxisFontSize":
            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"‚ÜîÔ∏è–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Å–µ–π",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_font_markup("axisfontsize", "statsAxisFontSize")
            )
        else:
            match callText[17:]:
                case "Add":
                    conf.set("stats_settings", "axisfontsize", str(int(conf["stats_settings"]["axisfontsize"]) + 2))
                case "Reduce":
                    conf.set("stats_settings", "axisfontsize", str(int(conf["stats_settings"]["axisfontsize"]) - 2))
            with open('config.ini', 'w') as config:
                conf.write(config)

            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"‚ÜîÔ∏è–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Å–µ–π",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_font_markup("axisfontsize", "statsAxisFontSize")
            )
    
    elif callText[:18] == "statsTicksFontSize":
        if callText == "statsAxisFontSize":
            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"‚ÜîÔ∏è–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Å–µ–π",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_font_markup("ticksfontsize", "statsTicksFontSize")
            )
        else:
            match callText[18:]:
                case "Add":
                    conf.set("stats_settings", "ticksfontsize", str(int(conf["stats_settings"]["ticksfontsize"]) + 2))
                case "Reduce":
                    conf.set("stats_settings", "ticksfontsize", str(int(conf["stats_settings"]["ticksfontsize"]) - 2))
            with open('config.ini', 'w') as config:
                conf.write(config)

            await bot.delete_message(
                chat_id=chatid,
                message_id=callback_query.message.message_id
            )
            await bot.send_photo(
                caption=f"‚ÜîÔ∏è–†–∞–∑–º–µ—Ä —Ç–µ–∫—Å—Ç–∞ –¥–ª—è –æ—Å–µ–π",
                chat_id=chatid,
                photo=stats.get_random_graph(),
                reply_markup=markups.get_stats_font_markup("ticksfontsize", "statsTicksFontSize")
            )

    elif callText[:5] == 'order':
        orderMarkup = types.InlineKeyboardMarkup()
        order_id = callText[5:]
        supportOrder = types.InlineKeyboardButton(text='üì±–û—Ç–∫—Ä—ã—Ç—å —Ç–∏–∫–µ—Ç –≤ —Ç–µ—Ö. –ø–æ–¥–¥–µ—Ä–∂–∫—É', callback_data=f'support{order_id}')
        orderMarkup.add(supportOrder)
        orderMarkup.add(markups.get_orders_back())
        c.execute(f"SELECT * FROM orders WHERE order_id={order_id}")
        for order in c:
            pass
        c.execute(f"SELECT * FROM items WHERE id={order[2]}")
        for item in c:
            pass
        itemName = item[1]
        login = order[3].split(':')[0]
        password = order[3].split(':')[1]
        date = order[4]
        text = f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n–ó–∞–∫–∞–∑ –Ω–æ–º–µ—Ä {order_id}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n' \
               f'–¢–æ–≤–∞—Ä: {itemName}\n' \
               f'–õ–æ–≥–∏–Ω: {login}\n' \
               f'–ü–∞—Ä–æ–ª—å: {password}\n' \
               f'–î–∞—Ç–∞ –∑–∞–∫–∞–∑–∞: {date}'
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=orderMarkup
        )

    elif callText[:7] == 'support':
        pass  # TODO: —Å–¥–µ–ª–∞—Ç—å —Å–∞–ø–ø–æ—Ä—Ç —á–µ—Ä–µ–∑ state_handler

    elif callText == 'seeSupportTickets':
        pass  # TODO: —Å–¥–µ–ª–∞—Ç—å –≤—ã–≤–æ–¥ —Ç–∏–∫—Ç–æ–≤

    elif callText == 'botSettings':
        await bot.edit_message_text(
            text="‚öô–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞",
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_settings_markup()
        )

    elif callText == "botSettingsDel":
        await bot.delete_message(
            chat_id=chatid,
            message_id=callback_query.message.message_id
        )
        await bot.send_message(
            text=f"‚öô–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–æ—Ç–∞",
            chat_id=callback_query.message.chat.id,
            reply_markup=markups.get_settings_markup()
        )

    elif callText == 'disableNotif':
        user.disable_notif()
        markupProfile = markups.get_markup_profile(user_id=chatid)
        await bot.edit_message_text(
            chat_id=chatid,
            message_id=callback_query.message.message_id,
            reply_markup=markupProfile,
            text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                 f"üìùid: {chatid}\n"
                 f"üìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(chatid))}\n"
                 f"üí∏–ë–∞–ª–∞–Ω—Å: {user.get_balance()}—Ä—É–±.\n"
                 f"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {user.get_register_date()}"
                 f"\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ",
        )

    elif callText == 'backProfile':
        markupProfile = markups.get_markup_profile(user_id=chatid)

        await bot.edit_message_text(
            chat_id=chatid,
            message_id=callback_query.message.message_id,
            reply_markup=markupProfile,
            text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                 f"üìùid: {chatid}\n"
                 f"üìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(chatid))}\n"
                 f"üí∏–ë–∞–ª–∞–Ω—Å: {user.get_balance()}—Ä—É–±.\n"
                 f"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {user.get_register_date()}"
                 f"\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ",
        )

    elif callText == 'enableNotif':
        user.enable_notif()
        markupProfile = markups.get_markup_profile(user_id=chatid)
        await bot.edit_message_text(
            chat_id=chatid,
            message_id=callback_query.message.message_id,
            reply_markup=markupProfile,
            text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n"
                 f"üìùid: {chatid}\n"
                 f"üìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(chatid))}\n"
                 f"üí∏–ë–∞–ª–∞–Ω—Å: {user.get_balance()}—Ä—É–±.\n"
                 f"–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {user.get_register_date()}"
                 f"\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ",
        )

    elif callText == 'goBackFaq':
        markupFAQ = markups.get_faq_markup()
        text = f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n' \
                f'‚ÑπÔ∏èFAQ –º–∞–≥–∞–∑–∏–Ω–∞ {conf["shop_settings"]["shop_name"]}\n' \
                f'‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ'
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markupFAQ
        )

    elif callText == 'backCat':
        catMarkup = types.InlineKeyboardMarkup()
        c.execute('SELECT * FROM cats')
        for category in c:
            btnCat = types.InlineKeyboardButton(text=category[1], callback_data=f"cat{category[0]}")
            catMarkup.add(btnCat)
        await bot.edit_message_text(
            text='‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüõçÔ∏è–ö–∞—Ç–µ–≥–æ—Ä–∏–∏\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ',
            chat_id=chatid,
            message_id=callback_query.message.message_id,
            reply_markup=catMarkup
        )

    elif callText == 'changeShopName':
        text = f"{conf['shop_settings']['shop_name']}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\""
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_main_settings(),
        )
        await state_handler.changeShopName.name.set()

    elif callText == 'changeContacts':
        text = f"{conf['shop_settings']['shop_contacts']}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ \"–ö–æ–Ω—Ç–∞–∫—Ç—ã\" –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\""
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_main_settings(),
        )
        await state_handler.changeShopContacts.text.set()

    elif callText == 'changeRefund':
        text = f"{conf['shop_settings']['refund_policy']}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ \"–ü–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞\" –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\""
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_main_settings(),
        )
        await state_handler.changeShopRefund.text.set()

    elif callText == 'changeQiwiNumber':
        text = f"{conf['payment_settings']['qiwi_number']}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –Ω–æ–º–µ—Ä QIWI –≤ —Ñ–æ—Ä–º–∞—Ç–µ \"+70000000000\" –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\""
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_qiwi_settings(),
        )
        await state_handler.changeQiwiNumber.number.set()

    elif callText == 'changeQiwiToken':
        text = f"{conf['payment_settings']['qiwi_token']}\n–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π —Ç–æ–∫–µ–Ω QIWI –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\""
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_qiwi_settings(),
        )
        await state_handler.changeQiwiToken.token.set()

    elif callText == 'changeMainBtc':
        text = f"{conf['payment_settings']['main_btc_adress']}\n–í–≤–µ–¥–∏—Ç–µ –æ—Å–Ω–æ–≤–Ω–æ–π Bitcoin –∫–æ—à–µ–ª—ë–∫ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\""
        await bot.edit_message_text(
            text=text,
            message_id=callback_query.message.message_id,
            chat_id=chatid,
            reply_markup=markups.get_cancel_states_btc_settings(),
        )
        await state_handler.changeMainBtc.wallet.set()

    elif callText == 'clientManagement':
        await bot.edit_message_text(
            chat_id=chatid,
            message_id=callback_query.message.message_id,
            text='üßç–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏',
            reply_markup=markups.get_client_management_markup(),
        )


@dp.message_handler(state=state_handler.addCat.catname)
async def addCat(message: types.Message, state: FSMContext):
    catname = message.text
    c.execute(f"SELECT * FROM cats WHERE name=\"{catname}\"")
    if not list(c):
        c.execute(f"INSERT INTO cats (name) VALUES(\"{catname}\")")
        conn.commit()
        await bot.send_message(
            text=f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º {catname} –±—ã–ª–∞ —Å–æ–∑–¥–∞–Ω–∞.",
            chat_id=message.chat.id,
            reply_markup=markups.get_items_back()
        )
    else:
        await bot.send_message(
            text=f"–ö–∞—Ç–µ–≥–æ—Ä–∏—è —Å –Ω–∞–∑–≤–∞–Ω–∏–µ–º {catname} —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!",
            chat_id=message.chat.id,
            reply_markup=markups.get_items_back()
        )
    await state.finish()
    

@dp.message_handler(state=state_handler.changeCatName.catname)
async def changeCatName(message: types.Message, state: FSMContext):
    catid = await state.get_data()
    catid = catid['catid']
    c.execute(f"SELECT * FROM cats WHERE id={catid}")
    oldcat = list(c)[0]
    try:
        c.execute(f"UPDATE cats SET name=\"{message.text}\" WHERE id={catid}")
        c.execute(f"SELECT * FROM cats WHERE id={catid}")
        newcat = list(c)[0]
        await bot.send_message(
            text=f"–ù–∞–∑–≤–∞–Ω–∏–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏ \"{oldcat[1]}\" —Å ID {catid} –±—ã–ª–æ –æ–±–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ \"{newcat[1]}\".",
            chat_id=message.chat.id,
            reply_markup=markups.get_back_cat_edit(catid)
        )
    except:
        await bot.send_message(
            text="–û—à–∏–±–∫–∞.",
            chat_id=message.chat.id,
            reply_markup=markups.get_back_cat_edit(catid)
        )
    await state.finish()
    

@dp.message_handler(state=state_handler.addItem.itemname)
async def addItemName(message: types.Message, state: FSMContext):
    itemname = message.text
    await state.update_data(itemname=itemname)
    markup = types.InlineKeyboardMarkup()
    c.execute(f"SELECT * FROM cats")
    for cat in list(c):
        markup.add(types.InlineKeyboardButton(text=f"[{cat[0]}] {cat[1]}", callback_data=f"addItemCat{cat[0]}"))
    markup.add(markups.btnCancelStateItems)
    await bot.send_message(
        text=f"–í–≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ç–µ–≥–æ—Ä–∏—é –¥–ª—è \"{itemname}\" –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\".",
        chat_id=message.chat.id,
        reply_markup=markup
    )
    await state_handler.addItem.cat.set()
    
    
@dp.callback_query_handler(state=state_handler.addItem.cat)
async def addItemCat(callback_query: types.CallbackQuery, state: FSMContext):
    if callback_query.data[:10] == "addItemCat":
        await state.update_data(cat=callback_query.data[10:])
        await bot.delete_message(
            chat_id=callback_query.message.chat.id,
            message_id=callback_query.message.message_id
        )
        await bot.send_message(
            text="–í–≤–µ–¥–∏—Ç–µ —Ü–µ–Ω—É —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\".",
            chat_id=callback_query.message.chat.id,
            reply_markup=markups.get_cancel_states_items()
        )
        await state_handler.addItem.price.set()
    elif callback_query.data == "cancelStateItems":
        await bot.edit_message_text(
                text="üì¶–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–º",
                message_id=callback_query.message.message_id,
                chat_id=callback_query.message.chat.id,
                reply_markup=markups.get_item_management_markup()
            )
        await state.finish()
        


@dp.callback_query_handler(state=state_handler.addItem.confirmation)
async def addItemConfirmation(callback_query: types.CallbackQuery, state: FSMContext):
    await bot.delete_message(chat_id=callback_query.message.chat.id, message_id=callback_query.message.message_id)
    if callback_query.data == "itmaddconfirm":
        item = await state.get_data()
        try:
            c.execute(f"INSERT INTO items (name, price, cat_id, desc, active) VALUES (\"{item['itemname']}\", {item['price']}, {item['cat']}, \"{item['desc']}\", 1)")
            conn.commit()
            await bot.send_message(
                text=f"–¢–æ–≤–∞—Ä \"{item['itemname']}\" –±—ã–ª —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω.",
                chat_id=callback_query.message.chat.id,
                reply_markup=markups.get_items_back()
            )
        except:
            await bot.send_message(
                text="–û—à–∏–±–∫–∞.",
                chat_id=callback_query.message.chat.id,
                reply_markup=markups.get_items_back()
            )
    elif callback_query.data == "deny":
        await bot.send_message()(
                text="üì¶–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–º",
                chat_id=callback_query.message.chat.id,
                reply_markup=markups.get_item_management_markup()
            )
    await state.finish()
          
    
    
@dp.message_handler(state=state_handler.addItem.price)
async def addItemPrice(message: types.Message, state: FSMContext):
    try:
        await state.update_data(price=float(message.text))
        await bot.send_message(
            text="–í–≤–µ–¥–∏—Ç–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É \"–ù–∞–∑–∞–¥\".",
            chat_id=message.chat.id,
            reply_markup=markups.get_cancel_states_items()
        )
        await state_handler.addItem.desc.set()
    except:
        await bot.send_message(
            text="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞.",
            chat_id=message.chat.id,
            reply_markup=markups.get_items_back()
        )
        await state.finish()
        
        
@dp.message_handler(state=state_handler.addItem.desc)
async def addItemDesc(message: types.Message, state: FSMContext):
    await state.update_data(desc=message.text)
    item = await state.get_data()
    markup = types.InlineKeyboardMarkup()
    markup.add(types.InlineKeyboardButton(text="‚úÖ–î–∞", callback_data="itmaddconfirm"), types.InlineKeyboardButton(text="‚ùå–ù–µ—Ç", callback_data="deny"))
    await bot.send_message(
        text=f"–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å {item['itemname']}?\n\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n{item['itemname']} - {item['price']}—Ä—É–±.\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\n{item['desc']}",
        chat_id=message.chat.id,
        reply_markup=markup
    )
    await state_handler.addItem.confirmation.set()
    
        

@dp.message_handler(state=state_handler.seeUserProfile.userid)
async def seeUserProfile(message: types.Message, state: FSMContext):
    userid = message.text
    if usr.does_user_exist(userid):
        profuser = usr.User(userid)
        text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
        await bot.send_message(
            text=text,
            chat_id=message.chat.id,
            reply_markup=markups.get_seeUserProfile_markup(userid)
        )
    else:
        await bot.send_message(
            text=f"–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å ID {userid} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç!",
            chat_id=message.chat.id
        )
    await state.finish()


@dp.message_handler(state=state_handler.changeUserBalance.bal)
async def changeUserBalance(message: types.Message, state: FSMContext):
    userid = await state.get_data()
    userid = userid['userid']
    profuser = usr.User(userid)
    try:
        usr.set_user_balance(userid, int(message.text), set_value=True)
        
        text2=f"–ë–∞–ª–∞–Ω—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {userid} –±—ã–ª –æ–±–Ω–æ–≤–ª–µ–Ω –¥–æ {message.text} —Ä—É–±."
    except:
        text2="–û—à–∏–±–∫–∞"
        
    text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"
    await bot.send_message(
        text=text,
        chat_id=message.chat.id,
        reply_markup=markups.get_seeUserProfile_markup(userid)
    )
    await bot.send_message(
        text=text2,
        chat_id=message.chat.id
    )
    await state.finish()


@dp.message_handler(state=state_handler.changeMainBtc.wallet)
async def changeQiwiToken(message: types.Message, state: FSMContext):
    conf.set('payment_settings', 'main_btc_adress', message.text)
    with open('config.ini', 'w') as config:
        conf.write(config)
    await bot.send_message(
        text='üíµ–ù–∞—Å—Ç—Ä–æ–π–∫–∏ BTC –∫–æ—à–µ–ª—å–∫–∞',
        chat_id=message.chat.id,
        reply_markup=markups.get_btc_settings_markup()
    )
    await bot.send_message(
        chat_id=message.chat.id,
        text=f"–û—Å–Ω–æ–≤–Ω–æ–π Bitcoin –∫–æ—à–µ–ª—ë–∫ –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ \"{message.text}\"",
    )
    await state.finish()


@dp.message_handler(state=state_handler.notifyAll.message)
async def notifyAll(message: types.Message, state: FSMContext):
    c.execute("SELECT * FROM users")
    successful = len(usr.get_user_list())
    try:
        for user in usr.get_user_list():
            await bot.send_message(
                text=message.text,
                chat_id=user[0]
            )
    except:
        successful -= 1
    await bot.send_message(
        text=f"–°–æ–æ–±—â–µ–Ω–∏–µ \"{message.text}\" –±—ã–ª–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ {successful} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º.",
        chat_id=message.chat.id
    )
    await state.finish()

    

@dp.message_handler(state=state_handler.changeQiwiToken.token)
async def changeQiwiToken(message: types.Message, state: FSMContext):
    conf.set('payment_settings', 'qiwi_token', message.text)
    with open('config.ini', 'w') as config:
        conf.write(config)
    await bot.send_message(
        text='ü•ù–ù–∞—Å—Ç—Ä–æ–π–∫–∏ QIWI –∫–æ—à–µ–ª—å–∫–∞',
        chat_id=message.chat.id,
        reply_markup=markups.get_qiwi_settings()
    )
    await bot.send_message(
        chat_id=message.chat.id,
        text=f"–¢–æ–∫–µ–Ω QIWI –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ \"{message.text}\""
    )
    await state.finish()


@dp.message_handler(state=state_handler.changeQiwiNumber.number)
async def changeQiwiNumber(message: types.Message, state: FSMContext):
    conf.set('payment_settings', 'qiwi_number', message.text)
    with open('config.ini', 'w') as config:
        conf.write(config)
    await bot.send_message(
        text='ü•ù–ù–∞—Å—Ç—Ä–æ–π–∫–∏ QIWI –∫–æ—à–µ–ª—å–∫–∞',
        chat_id=message.chat.id,
        reply_markup=markups.get_qiwi_settings()
    )
    await bot.send_message(
        chat_id=message.chat.id,
        text=f"–ù–æ–º–µ—Ä QIWI –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ \"{message.text}\"",
    )
    await state.finish()


@dp.message_handler(state=state_handler.changeShopRefund.text)
async def changeShopRefund(message: types.Message, state: FSMContext):
    conf.set('shop_settings', 'refund_policy', message.text)
    with open('config.ini', 'w') as config:
        conf.write(config)
    await bot.send_message(
        text='üõ†–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
        chat_id=message.chat.id,
        reply_markup=markups.get_main_settings_markup()
    )
    await bot.send_message(
        chat_id=message.chat.id,
        text=f"–¢–µ–∫—Å—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ \"–ü–æ–ª–∏—Ç–∏–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞\" –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ \"{message.text}\"",
    )
    await state.finish()


@dp.message_handler(state=state_handler.changeShopContacts.text)
async def changeShopContacts(message: types.Message, state: FSMContext):
    conf.set('shop_settings', 'shop_contacts', message.text)
    with open('config.ini', 'w') as config:
        conf.write(config)
    await bot.send_message(
        text='üõ†–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
        chat_id=message.chat.id,
        reply_markup=markups.get_main_settings_markup()
    )
    await bot.send_message(
        chat_id=message.chat.id,
        text=f"–¢–µ–∫—Å—Ç –¥–ª—è –≤–∫–ª–∞–¥–∫–∏ \"–ö–æ–Ω—Ç–∞–∫—Ç—ã\" –±—ã–ª –∏–∑–º–µ–Ω–µ–Ω –Ω–∞ \"{message.text}\"",
    )
    await state.finish()


@dp.message_handler(state=state_handler.changeShopName.name)
async def changeShopName(message: types.Message, state: FSMContext):
    conf.set('shop_settings', 'shop_name', message.text)
    with open('config.ini', 'w') as config:
        conf.write(config)
    await bot.send_message(
        text='üõ†–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
        chat_id=message.chat.id,
        reply_markup=markups.get_main_settings_markup()
    )
    await bot.send_message(
        chat_id=message.chat.id,
        text=f"–ù–∞–∑–≤–∞–Ω–∏–µ –º–∞–≥–∞–∑–∏–Ω–∞ –±—ã–ª–æ –∏–∑–º–µ–Ω–µ–Ω–æ –Ω–∞ \"{message.text}\"",
    )
    await state.finish()


@dp.callback_query_handler(state='*')
async def cancelState(callback_query: types.CallbackQuery, state: FSMContext):
    chatid = callback_query.message.chat.id
    user = User(chatid)
    call = callback_query.data
    if call == 'cancelStateMainSettings':
        if user.is_admin():
            await bot.edit_message_text(
                text='üõ†–û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏',
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.get_main_settings_markup()
            )
            
    elif call[:15] == "cancelStateUser":
        if user.is_admin():
            userid = call[15:]
            profuser = usr.User(userid)
            text=f"‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ\nüìùid: {userid}\nüìà–ö–æ–ª-–≤–æ –∑–∞–∫–∞–∑–æ–≤: {len(usr.get_user_orders(userid))}\nüí∏–ë–∞–ª–∞–Ω—Å: {profuser.get_balance()} —Ä—É–±.\n–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: {profuser.get_register_date()}\n‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ‚ûñ"

            await bot.edit_message_text(
                text=text,
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.get_seeUserProfile_markup(userid)
            )
            
    elif call[:14] == "cancelStateCat":
        if user.is_admin():
            catid = call[14:]
            c.execute(F"SELECT * FROM cats WHERE id={catid}")
            cat = list(c)[0]
            
            await bot.edit_message_text(
                text=cat[1],
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.get_cat_edit_markup(cat[0])
        )
    
    elif call == "cancelStateItems":
        if user.is_admin():
            await bot.edit_message_text(
                text="üì¶–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–æ–º",
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.get_item_management_markup()
            )

    elif call == 'cancelStateQiwiSettings':
        if user.is_admin():
            await bot.edit_message_text(
                text='ü•ù–ù–∞—Å—Ç—Ä–æ–π–∫–∏ QIWI –∫–æ—à–µ–ª—å–∫–∞',
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.get_qiwi_settings()
            )

    elif call == 'cancelStateBTCSettings':
        if user.is_admin():
            await bot.edit_message_text(
                text='üíµ–ù–∞—Å—Ç—Ä–æ–π–∫–∏ BTC –∫–æ—à–µ–ª—å–∫–∞',
                message_id=callback_query.message.message_id,
                chat_id=chatid,
                reply_markup=markups.get_btc_settings_markup()
            )
            
    elif call == "cancelStateNotifyAll":
        if user.is_admin():
            await bot.edit_message_text(
                chat_id=chatid,
                message_id=callback_query.message.message_id,
                text="üßç–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏",
                reply_markup=markups.get_client_management_markup()
            )

    elif call == 'cancelStateClients':
        if user.is_admin():
            await bot.edit_message_text(
                chat_id=chatid,
                message_id=callback_query.message.message_id,
                text='üßç–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏',
                reply_markup=markups.get_client_management_markup(),
            )

    await state.finish()


if __name__ == '__main__':
    executor.start_polling(dp, skip_updates=True)

